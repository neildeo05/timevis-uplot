<!--- TODO: Fix Labels --->
<!--- TODO: Update spans --->
<!DOCTYPE html>
<html>
  <head>
    <title>Timevis</title>
    <link rel="stylesheet" href="../stylesheets/uPlot.min.css">
    <link rel="stylesheet" href="../stylesheets/styles.css">
  </head>
  <body>
    <p id='foo'>Centering on: </p>
    <p id='bar'>Current Level: 6</p>
  <script src="../js-scripts/uPlot.iife.js"></script>
  <script>

    fetch('http://localhost:8000/getAllData', {
	method: "POST",
	body: JSON.stringify({plot_type: 'test_all_levels', max_x_values: 10_000_000, level: 6})
    }).then(res => res.json())
    .then(json => {
	// const data = [
	//     [ 1, 2, 3, 4, 5, 6, 7, 9,10],
	//     [40,43,60,65,71,73,40,22,20],
	//     [30,23,35,27,11,13,30,32,30],
	//     [15,13,39,17,21,53,10,11,13],
	// ];
	const data = json.data
	const opts = {
	    width: 1300,
	    height: 600,

	    cursor: {
		drag: {
		    setScale: false,
		    x: true,
		    y: false,
		}
	    },
	    axes: [
		{
		    space: 60
		},
		{
		    show: true,
		    label: "Healthy Rat",
		    labelSize: 30,
		    labelFont: "bold 12px Arial",
		    font: "12px Arial",
		    gap: 5,
		    size: 100,
		    stroke: "black",
		    grid: {
			show: true,
			stroke: "#eee",
			width: 2,
			dash: [],
		    },
		    ticks: {
			show: true,
			stroke: "#eee",
			width: 2,
			dash: [],
			size: 20,
		    }
		}
	    ],
	    scales: {
		x: {
		    time: false,
		}
	    },
	    series: [
		{},
		{
		    stroke: "black"
		}
	    ],
	    hooks: {
		init: [
		    u => {
			u.over.ondblclick = e => {
			    console.log("Fetching data for full range");
				// <h1 id='bar'>Current Level: </h1>
			    document.getElementById('bar').innerText = "Current Level: 6";
			    u.setData(data);
			}
		    }
		],
		setSelect: [
		    u => {
			let min = u.posToVal(u.select.left, 'x');
			let max = u.posToVal(u.select.left + u.select.width, 'x');

			console.log("Fetching data for range...", {min, max});
			console.log("Centering on..." , Math.floor(Math.ceil(max - min) / 2));
			document.getElementById('foo').innerText = `Centering on: ${ Math.ceil(min) + Math.floor(Math.floor(Math.ceil(max - min) / 2))}`
			// let foo = Math.pow(2, 6) * Math.ceil(min);
			// let bar = Math.pow(2, 6) * Math.ceil(max);
			// if (foo > 10000000 || bar > 10000000) {
			//     foo = min
			//     bar = max
			// }
			fetch('http://localhost:8000/getRange', {
			    method: "POST",
			    //TODO: Math.pow should be on serve
			    body: JSON.stringify({plot_type: 'test_all_levels', max_x_values: 10_000_000, range_min: min, range_max: max})
			}).then(res => res.json())
			    .then(json2 => {
				console.log(json2)
				u.setData(json2.data);
				console.log(json2.level);
				document.getElementById('bar').innerText = `Current Level: ${json2.level}`;
			    })
			
		
			// set new data


			// zoom to selection
			// u.setScale('x', {min, max});

			// reset selection
			u.setSelect({width: 0, height: 0}, false);
		    }
		]
	    }
	};

	let u = new uPlot(opts, data, document.body);
    })
  </script>
</body>
</html>
